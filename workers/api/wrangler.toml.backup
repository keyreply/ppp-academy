name = "ppp-academy-api"
main = "src/index.ts"
compatibility_date = "2025-11-27"
account_id = "2e25a3c929c0317b8c569a9e7491cf78"

# ============================================
# Durable Object bindings
# ============================================

[[durable_objects.bindings]]
name = "TENANT"
class_name = "TenantDO"

[[durable_objects.bindings]]
name = "CUSTOMER"
class_name = "CustomerDO"

[[durable_objects.bindings]]
name = "CONVERSATION"
class_name = "ConversationDO"

[[durable_objects.bindings]]
name = "RATE_LIMITER"
class_name = "RateLimiterDO"

[[durable_objects.bindings]]
name = "AGENT"
class_name = "AgentDO"

[[durable_objects.bindings]]
name = "NOTIFICATION"
class_name = "NotificationDO"

[[durable_objects.bindings]]
name = "WORKFLOW"
class_name = "WorkflowDO"

[[durable_objects.bindings]]
name = "ANALYTICS"
class_name = "AnalyticsDO"

[[durable_objects.bindings]]
name = "CAMPAIGN"
class_name = "CampaignDO"

# SQLite migrations for Durable Objects
[[migrations]]
tag = "v1"
new_sqlite_classes = [
  "TenantDO",
  "CustomerDO",
  "ConversationDO",
  "RateLimiterDO",
  "AgentDO",
  "NotificationDO",
  "WorkflowDO",
  "AnalyticsDO"
]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["CampaignDO"]

# ============================================
# Storage bindings
# ============================================

# R2 bucket for document storage
[[r2_buckets]]
binding = "DOCS_BUCKET"
bucket_name = "ppp-academy-docs"

# D1 database for relational data
[[d1_databases]]
binding = "DB"
database_name = "ppp-academy-db"
database_id = "07595b3b-08e9-475e-ba87-eb981fce2dfe"

# Vectorize index for RAG
# IMPORTANT: Create with 1024 dimensions for Qwen3 Embedding model:
# wrangler vectorize create ppp-academy-vectors --dimensions=1024 --metric=cosine
[[vectorize]]
binding = "VECTORIZE"
index_name = "ppp-academy-vectors"

# Queue for async processing
[[queues.producers]]
binding = "DOCUMENT_QUEUE"
queue = "ppp-academy-document-processing"

[[queues.consumers]]
queue = "ppp-academy-document-processing"
max_batch_size = 10
max_batch_timeout = 30

[[queues.producers]]
binding = "ANALYTICS_QUEUE"
queue = "ppp-academy-analytics"

[[queues.consumers]]
queue = "ppp-academy-analytics"
max_batch_size = 100
max_batch_timeout = 10

[[queues.producers]]
binding = "EMAIL_QUEUE"
queue = "ppp-academy-emails"

[[queues.consumers]]
queue = "ppp-academy-emails"
max_batch_size = 10
max_batch_timeout = 5

# Workers AI
[ai]
binding = "AI"

# ============================================
# Environment Variables
# ============================================

[vars]
ENVIRONMENT = "development"

# Email provider: "cloudflare" (default) or "resend" (production)
# For Cloudflare: Uses MailChannels API (free) or EMAIL binding
# For Resend: Set EMAIL_PROVIDER="resend" and add RESEND_API_KEY secret
EMAIL_PROVIDER = "cloudflare"

# ============================================
# Secrets (add via: wrangler secret put <NAME>)
# ============================================
# RESEND_API_KEY     - For production email (Resend)

# ============================================
# Production Environment (uncomment for production)
# ============================================
# [env.production.vars]
# ENVIRONMENT = "production"
# EMAIL_PROVIDER = "resend"
# STT_PROVIDER = "deepgram"
