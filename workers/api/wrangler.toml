name = "keyreply-kira-api"
main = "src/index.ts"
compatibility_date = "2025-11-27"
account_id = "2e25a3c929c0317b8c569a9e7491cf78"

# ============================================
# Durable Object bindings
# ============================================

[[durable_objects.bindings]]
name = "TENANT"
class_name = "TenantDO"

[[durable_objects.bindings]]
name = "CUSTOMER"
class_name = "CustomerDO"

[[durable_objects.bindings]]
name = "CONVERSATION"
class_name = "ConversationDO"

[[durable_objects.bindings]]
name = "RATE_LIMITER"
class_name = "RateLimiterDO"

[[durable_objects.bindings]]
name = "AGENT"
class_name = "AgentDO"

[[durable_objects.bindings]]
name = "NOTIFICATION"
class_name = "NotificationDO"

[[durable_objects.bindings]]
name = "WORKFLOW"
class_name = "WorkflowDO"

[[durable_objects.bindings]]
name = "ANALYTICS"
class_name = "AnalyticsDO"

[[durable_objects.bindings]]
name = "CAMPAIGN"
class_name = "CampaignDO"

# SQLite migrations for Durable Objects
[[migrations]]
tag = "v1"
new_sqlite_classes = [
  "TenantDO",
  "CustomerDO",
  "ConversationDO",
  "RateLimiterDO",
  "AgentDO",
  "NotificationDO",
  "WorkflowDO",
  "AnalyticsDO"
]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["CampaignDO"]

# ============================================
# Storage bindings
# ============================================

# R2 bucket for document storage
[[r2_buckets]]
binding = "DOCS_BUCKET"
bucket_name = "keyreply-kira-docs"

# D1 database for relational data
[[d1_databases]]
binding = "DB"
database_name = "keyreply-kira-db"
database_id = "cafcc326-7c01-4a14-96e8-0500b26d03d6"

# Vectorize index for RAG
# IMPORTANT: Created with 1024 dimensions for Qwen3 Embedding model
[[vectorize]]
binding = "VECTORIZE"
index_name = "keyreply-kira-vectors"

# Queue for document processing
[[queues.producers]]
binding = "DOCUMENT_QUEUE"
queue = "keyreply-kira-documents"

[[queues.consumers]]
queue = "keyreply-kira-documents"
max_batch_size = 10
max_batch_timeout = 30

# Queue for analytics events
[[queues.producers]]
binding = "ANALYTICS_QUEUE"
queue = "keyreply-kira-analytics"

[[queues.consumers]]
queue = "keyreply-kira-analytics"
max_batch_size = 100
max_batch_timeout = 10

# Queue for email sending
[[queues.producers]]
binding = "EMAIL_QUEUE"
queue = "keyreply-kira-emails"

[[queues.consumers]]
queue = "keyreply-kira-emails"
max_batch_size = 10
max_batch_timeout = 5


# Workers for Platforms - Dispatch Namespace
# NOTE: Requires Workers for Platforms subscription. Uncomment when available.
# [[dispatch_namespaces]]
# binding = "DISPATCHER"
# namespace = "keyreply-functions"

# Service Binding to Voice Worker (for voice AI calls)
[[services]]
binding = "VOICE_SERVICE"
service = "voice-agent"

# Workers AI
[ai]
binding = "AI"

# ============================================
# Environment Variables
# ============================================

[vars]
ENVIRONMENT = "development"

# Email provider: "cloudflare" (default) or "resend" (production)
# For Cloudflare: Uses MailChannels API (free) or EMAIL binding
# For Resend: Set EMAIL_PROVIDER="resend" and add RESEND_API_KEY secret
EMAIL_PROVIDER = "cloudflare"
ACCOUNT_ID = "2e25a3c929c0317b8c569a9e7491cf78"

# ============================================
# Secrets (add via: wrangler secret put <NAME>)
# ============================================
# RESEND_API_KEY     - For production email (Resend)
# CLOUDFLARE_API_TOKEN - For managing Platform Functions

# ============================================
# Production Environment
# ============================================
[env.production]
name = "keyreply-kira-api"

[env.production.vars]
ENVIRONMENT = "production"
EMAIL_PROVIDER = "resend"

# ============================================
# Staging Environment
# ============================================
[env.staging]
name = "keyreply-kira-api-staging"

[env.staging.vars]
ENVIRONMENT = "staging"
EMAIL_PROVIDER = "cloudflare"
